# ----------------------------------------------------
# ----- prompt -----------------------------------------
# ----------------------------------------------------

source ~/.config/zsh/prompt.zsh

# ----------------------------------------------------
# ----- env -------------------------------------------
# ----------------------------------------------------

{{ range $name, $val := .shell.env -}}
{{-   if kindIs "map" $val }}
if command -v {{ $val.check }} &> /dev/null; then
    export {{ $name }}="{{ $val.value }}"
else
    export {{ $name }}="{{ $val.fallback }}"
fi
{{-   else if hasPrefix "." $val }}
export {{ $name }}="$HOME/{{ $val }}"
{{-   else }}
export {{ $name }}="{{ $val }}"
{{-   end }}
{{ end }}

# ----------------------------------------------------
# ----- opts ------------------------------------------
# ----------------------------------------------------

stty -ixon  # disable XON/XOFF flow control (frees Ctrl+S/Q)

setopt AUTO_CD
setopt HIST_IGNORE_DUPS
setopt SHARE_HISTORY
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
WORDCHARS='*?_[]~=&;!#$%^(){}<>'

# ----------------------------------------------------
# ----- completion ------------------------------------
# ----------------------------------------------------

autoload -Uz compinit && compinit
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

# ----------------------------------------------------
# ----- plugins ----------------------------------------
# ----------------------------------------------------

source <(fzf --zsh)
source ~/.zsh/fzf-tab/fzf-tab.plugin.zsh
source ~/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh
source ~/.zsh/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh

# up/down search history filtered by current input
autoload -Uz up-line-or-beginning-search down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search
bindkey '^[[A' up-line-or-beginning-search
bindkey '^[[B' down-line-or-beginning-search
bindkey '^[[H' beginning-of-line
bindkey '^[[F' end-of-line

# ----------------------------------------------------
# ----- funcs -----------------------------------------
# ----------------------------------------------------

{{ range $name, $func := .shell.functions -}}
# {{ $func.description }}
{{ $name }}() {
    {{ $func.zsh }}
}

{{ end }}

# ----------------------------------------------------
# ----- alias -----------------------------------------
# ----------------------------------------------------

{{ range $name, $cmd := .shell.aliases -}}
alias {{ $name }}='{{ $cmd }}'
{{ end }}

# edit zshrc chezmoi source
alias configzsh='$EDITOR $(chezmoi source-path)/dot_zshrc.tmpl'
{{- if eq .chezmoi.os "darwin" }}

alias typora='open -a typora'
{{- end }}

# ----------------------------------------------------
# ----- colors ----------------------------------------
# ----------------------------------------------------

export CLICOLOR=1
export LSCOLORS=ExGxBxDxCxEgEdxbxgxcxd

# ----------------------------------------------------
# ----- fnm (node version manager) --------------------
# ----------------------------------------------------

eval "$(fnm env --use-on-cd)"

# ----------------------------------------------------
# ----- mise (tool version manager) -------------------
# ----------------------------------------------------

eval "$(~/.local/bin/mise activate zsh)"

if command -v wt >/dev/null 2>&1; then eval "$(command wt config shell init zsh)"; fi

gbb() {
    command gbb "$@"
    local result="/tmp/gbb-$(id -u)-result"
    if [ -f "$result" ]; then
        cd "$(cat "$result")" && rm -f "$result"
    fi
}

